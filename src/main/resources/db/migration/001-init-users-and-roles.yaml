databaseChangeLog:
  - changeSet:
      id: 001-users
      author: кощей бесстыжий ayzek
      changes:
        - createTable:
            tableName: users
            remarks: "Пользователи"
            columns:
              - column: { name: id, type: BIGINT, autoIncrement: true,
                          constraints: { primaryKey: true, primaryKeyName: pk_users, nullable: false } }
              - column: { name: username, type: VARCHAR(64), constraints: { nullable: false, unique: true } }
              - column: { name: password, type: TEXT, constraints: { nullable: false } }
              - column: { name: full_name, type: TEXT, constraints: { nullable: false } }
              - column: { name: enabled, type: BOOLEAN, defaultValueBoolean: true, constraints: { nullable: false } }
              - column: { name: created_at, type: TIMESTAMPTZ, defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: TIMESTAMPTZ, defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }

        - addUniqueConstraint:
            tableName: users
            columnNames: username
            constraintName: uq_users_username

        - createTable:
            tableName: user_roles
            remarks: "Роли пользователя (ADMIN/USER)"
            columns:
              - column: { name: user_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: role, type: VARCHAR(16), constraints: { nullable: false } }

        - addPrimaryKey:
            tableName: user_roles
            columnNames: user_id, role
            constraintName: pk_user_roles

        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_user_roles_user

        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              ALTER TABLE user_roles
              ADD CONSTRAINT chk_user_roles_role
              CHECK (role IN ('ADMIN','USER'));
      rollback:
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              ALTER TABLE user_roles DROP CONSTRAINT IF EXISTS chk_user_roles_role;
        - dropForeignKeyConstraint:
            baseTableName: user_roles
            constraintName: fk_user_roles_user
        - dropTable: { tableName: user_roles }
        - dropUniqueConstraint:
            tableName: users
            constraintName: uq_users_username
        - dropTable: { tableName: users }